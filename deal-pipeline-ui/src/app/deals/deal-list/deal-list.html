<div class="page-container">
  <!-- Filter Toolbar -->
  <div class="toolbar">
    <div class="filters">
      <mat-form-field appearance="outline">
        <mat-label>Stage</mat-label>
        <mat-select [(ngModel)]="stage" (closed)="loadDeals()">
          <mat-option value="">All Stages</mat-option>
          <mat-option *ngFor="let s of stages" [value]="s.value">
            {{ s.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Sector</mat-label>
        <mat-select [(ngModel)]="sector" (closed)="loadDeals()">
          <mat-option value="">All Sectors</mat-option>
          <mat-option value="Technology">Technology</mat-option>
          <mat-option value="Energy">Energy</mat-option>
          <mat-option value="Healthcare">Healthcare</mat-option>
          <mat-option value="Finance">Finance</mat-option>
          <mat-option value="Manufacturing">Manufacturing</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <button
      mat-raised-button
      color="primary"
      routerLink="/deals/create">
      Create Deal
    </button>
  </div>

  <!-- Deal List Card -->
  <mat-card class="deal-card" *ngIf="isLoaded">
    <h3 class="card-title">Deal List</h3>
    
    <table mat-table [dataSource]="deals" class="deal-table">

      <!-- Title Column -->
      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef>Title</th>
        <td mat-cell *matCellDef="let deal" class="title-cell">
          <ng-container *ngIf="isEditing(deal.id); else viewTitle">
            <input class="table-input" type="text" [(ngModel)]="editModel.title" />
          </ng-container>
          <ng-template #viewTitle>
            <span matTooltip="{{ deal.title }}">{{ deal.title }}</span>
          </ng-template>
        </td>
      </ng-container>

      <!-- Sector Column -->
      <ng-container matColumnDef="sector">
        <th mat-header-cell *matHeaderCellDef>Sector</th>
        <td mat-cell *matCellDef="let deal">
          <ng-container *ngIf="isEditing(deal.id); else viewSector">
            <select class="table-select" [(ngModel)]="editModel.sector">
              <option *ngFor="let s of sectors" [value]="s">{{ s }}</option>
            </select>
          </ng-container>
          <ng-template #viewSector>
            <span class="cell-text">{{ deal.sector }}</span>
          </ng-template>
        </td>
      </ng-container>

      <!-- Deal Type Column -->
      <ng-container matColumnDef="dealType">
        <th mat-header-cell *matHeaderCellDef>Deal Type</th>
        <td mat-cell *matCellDef="let deal">
          <ng-container *ngIf="isEditing(deal.id); else viewDealType">
            <select class="table-select" [(ngModel)]="editModel.dealType">
              <option *ngFor="let t of dealTypes" [value]="t.value">{{ t.label }}</option>
            </select>
          </ng-container>
          <ng-template #viewDealType>
            <span class="cell-text">{{ getDealTypeLabel(deal.dealType) }}</span>
          </ng-template>
        </td>
      </ng-container>

      <!-- Stage Column -->
      <ng-container matColumnDef="stage">
        <th mat-header-cell *matHeaderCellDef>Stage</th>
        <td mat-cell *matCellDef="let deal">
          <ng-container *ngIf="isEditing(deal.id); else viewStage">
            <select class="table-select" [(ngModel)]="editModel.stage">
              <option *ngFor="let s of stages" [value]="s.value">{{ s.label }}</option>
            </select>
          </ng-container>
          <ng-template #viewStage>
            <span class="stage-badge" [ngClass]="getStageClass(deal.stage)">
              {{ getStageLabel(deal.stage) }}
            </span>
          </ng-template>
        </td>
      </ng-container>

      <!-- Deal Value Column (ADMIN ONLY) -->
      <ng-container matColumnDef="dealValue">
        <th mat-header-cell *matHeaderCellDef>Deal Value</th>
        <td mat-cell *matCellDef="let deal">
          <ng-container *ngIf="isEditing(deal.id); else viewDealValue">
            <input class="table-input" type="number" [(ngModel)]="$any(editModel).dealValue" />
          </ng-container>
          <ng-template #viewDealValue>
            <span class="cell-text">{{ $any(deal).dealValue | currency:'USD':'symbol' }}</span>
          </ng-template>
        </td>
      </ng-container>

      <!-- Created By Column -->
      <ng-container matColumnDef="createdBy">
        <th mat-header-cell *matHeaderCellDef>Created By</th>
        <td mat-cell *matCellDef="let deal">
          <span class="cell-text" matTooltip="{{ deal.ownerId }}">{{ getCreatedByDisplay(deal.ownerId) }}</span>
        </td>
      </ng-container>

      <!-- Created On Column -->
      <ng-container matColumnDef="createdOn">
        <th mat-header-cell *matHeaderCellDef>Created On</th>
        <td mat-cell *matCellDef="let deal">
          <span class="cell-text" matTooltip="{{ deal.createdAt }}">{{ getCreatedOnDisplay(deal.createdAt) }}</span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let deal" class="actions-cell">
          <div class="actions-wrap">
            <ng-container *ngIf="isEditing(deal.id); else viewActions">
              <button mat-icon-button color="primary" (click)="saveEdit(deal.id)" matTooltip="Save">
                <mat-icon>check</mat-icon>
              </button>
              <button mat-icon-button (click)="cancelEdit()" matTooltip="Cancel">
                <mat-icon>close</mat-icon>
              </button>
            </ng-container>
            <ng-template #viewActions>
              <button mat-icon-button color="primary" (click)="startEdit(deal)" matTooltip="Edit">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="accent" (click)="openNotes(deal)" matTooltip="View Notes">
                <mat-icon>notes</mat-icon>
              </button>
              <button *ngIf="isAdmin" mat-icon-button color="warn" (click)="deleteDeal(deal.id)" matTooltip="Delete">
                <mat-icon>delete</mat-icon>
              </button>
            </ng-template>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

    </table>
  </mat-card>

  <div *ngIf="isLoaded && dealCount === 0" class="empty">
    <p>No deals found</p>
  </div>

  <div class="footer">Â© 2026 Deal Pipeline. All rights reserved.</div>
</div>
